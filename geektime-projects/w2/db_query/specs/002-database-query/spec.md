# Feature Specification: Database Query Tool

**Feature Branch**: `002-database-query`
**Created**: 2025-12-25
**Status**: Draft
**Input**: User description: "这是一个数据库查询工具，用户可以添加一个 db url，系统会连接到数据库，获取数据库的 metadta，然后将数据库中的 table 和 view 的信息展示出来，然后用户可以自己输入 sql 查询，也可以通过自然语言来生成 sql 查询。基本想法：数据库连接字符串和数据库的 metadata 都会存储到 sqlite 数据库中。我们可以根据 postgres 的功能来查询系统中的表和视图的信息，然后用 LLM 来将这些信息转换成 json 格式，然后存储到 sqlite 数据库中。这个信息以后可以复用。当用户使用 LLM 来生成 sql 查询时，我们可以把系统中的表和视图的信息作为 context 传递给 LLM，然后 LLM 会根据这些信息来生成 sql 查询。任何输入的 sql 语句，都需要经过 sqlparser 解析，确保语法正确，并且仅包含 select 语句。如果语法不正确，需要给出错误信息。如果查询不包含 limit 子句，则默认添加 limit 1000 子句。输出格式是 json，前端将其组织成表格，并显示出来。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Manage Database Connections (Priority: P1)

用户可以通过输入数据库连接字符串来添加数据库连接，系统会验证连接有效性并保存。用户可以查看所有已添加的数据库列表，包括连接状态、数据库名称和基本信息。用户也可以删除不再使用的数据库连接。

**Why this priority**: 这是整个系统的核心基础，没有数据库连接就无法进行任何查询操作。这是用户进入系统后必须完成的第一步。

**Independent Test**: 可以通过添加、列出、删除数据库连接来独立测试，不需要依赖查询功能。

**Acceptance Scenarios**:

1. **Given** 用户在数据库连接页面，**When** 用户输入有效的 PostgreSQL 连接字符串并提交，**Then** 系统验证连接成功，将连接信息保存到本地存储，并在数据库列表中显示该数据库
2. **Given** 用户输入无效的连接字符串，**When** 用户提交连接信息，**Then** 系统显示友好的错误提示信息，说明连接失败的原因
3. **Given** 数据库列表中存在已有连接，**When** 用户点击删除按钮并确认，**Then** 系统删除该连接信息并刷新列表

---

### User Story 2 - View Database Metadata (Priority: P1)

用户选择一个已连接的数据库后，系统会自动提取该数据库的元数据信息，包括所有表和视图的列表。对于每个表和视图，显示其列名、数据类型、主键、外键等结构信息。这些信息以清晰的层级结构展示，方便用户理解数据库结构。

**Why this priority**: 了解数据库结构是编写 SQL 查询的前提，这个功能让用户能够快速探索和熟悉数据库结构。

**Independent Test**: 可以通过添加数据库连接后查看元数据来独立测试，不依赖查询功能。

**Acceptance Scenarios**:

1. **Given** 用户已添加数据库连接，**When** 用户在列表中选择该数据库，**Then** 系统连接数据库，提取表和视图的元数据，并在界面中展示结构化信息
2. **Given** 数据库包含多个表和视图，**When** 元数据加载完成，**Then** 用户可以看到按名称排序的表和视图列表，点击任意项可展开查看详细的结构信息（列名、类型、约束等）
3. **Given** 数据库元数据已提取，**When** 用户下次选择同一数据库，**Then** 系统优先使用本地缓存的数据，加载速度明显快于首次提取

---

### User Story 3 - Execute SQL Queries (Priority: P2)

用户可以在 SQL 编辑器中手动编写 SELECT 查询语句，系统会验证 SQL 语法，确保只允许 SELECT 操作。验证通过后执行查询，并将结果以表格形式展示。如果查询未包含 LIMIT 子句，系统自动添加 LIMIT 1000。

**Why this priority**: 这是用户进行数据探索的核心功能，但依赖于前两个基础功能。

**Independent Test**: 可以在有数据库连接和元数据的情况下，通过执行各种 SELECT 查询来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户选择了数据库并打开了 SQL 编辑器，**When** 用户输入有效的 SELECT 语句并执行，**Then** 系统解析验证 SQL，执行查询，并在结果区域以表格形式展示数据
2. **Given** 用户输入的 SELECT 语句没有 LIMIT 子句，**When** 用户执行查询，**Then** 系统自动在查询末尾添加 LIMIT 1000 并执行
3. **Given** 用户输入的 SQL 语句语法错误，**When** 用户执行查询，**Then** 系统在界面上显示具体的错误信息，指出错误位置和原因
4. **Given** 用户尝试执行非 SELECT 语句（如 UPDATE/DELETE），**When** 用户执行查询，**Then** 系统拒绝执行并显示明确的错误提示："仅允许 SELECT 查询"

---

### User Story 4 - Generate SQL from Natural Language (Priority: P3)

用户可以用自然语言描述查询需求（如"显示所有销售额超过1000的订单"），系统基于当前数据库的元数据上下文，使用 AI 智能模型生成对应的 SQL 查询语句。用户可以查看生成的 SQL，进行修改后执行。

**Why this priority**: 这是增强用户体验的功能，降低 SQL 编写门槛，但基础查询功能已能满足核心需求。

**Independent Test**: 可以在有数据库连接和元数据的情况下，通过输入自然语言并验证生成的 SQL 来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户选择了数据库，**When** 用户在自然语言输入框输入查询描述并提交，**Then** 系统结合数据库元数据生成 SQL 语句，并在编辑器中显示
2. **Given** 用户输入的自然语言描述模糊或不完整，**When** 系统生成 SQL，**Then** 生成的 SQL 应该包含合理的推断，用户可以在执行前修改
3. **Given** 生成的 SQL 显示在编辑器中，**When** 用户点击执行按钮，**Then** 系统按照 SQL 查询的流程执行并展示结果

---

### User Story 5 - View and Export Query Results (Priority: P2)

查询执行后，结果以表格形式展示，支持分页显示大量数据。用户可以导出查询结果为常见格式（如 CSV、Excel 兼容格式）。

**Why this priority**: 这是查询功能的必要补充，让用户能够有效使用查询结果。

**Independent Test**: 可以通过执行查询并验证结果展示和导出功能来独立测试。

**Acceptance Scenarios**:

1. **Given** 查询成功执行并返回结果，**When** 结果数据量较大，**Then** 系统使用分页展示，每页显示合理数量的行
2. **Given** 查询结果显示在表格中，**When** 用户点击导出按钮并选择格式，**Then** 系统生成对应格式的文件并下载
3. **Given** 查询返回空结果，**When** 查询执行完成，**Then** 系统显示友好的"无数据"提示信息

---

### Edge Cases

- 当数据库连接超时或网络中断时，系统如何处理？
- 当查询结果包含非常大的文本或二进制数据时，如何展示？
- 当数据库表名或列名包含特殊字符或关键字时，SQL 生成如何处理？
- 当多个用户同时操作同一个数据库连接时，如何保证一致性？
- 当数据库元数据发生变化（如表结构变更）后，缓存如何更新？
- 当自然语言生成的 SQL 包含语法错误时，如何向用户反馈？
- 当查询执行时间过长（如超过 60 秒）时，如何处理？
- 当数据库权限不足以访问某些表时，如何处理？

## Requirements *(mandatory)*

### Functional Requirements

#### 数据库连接管理

- **FR-001**: 系统 MUST 允许用户通过输入数据库连接字符串（connection URL）来添加数据库连接
- **FR-002**: 系统 MUST 验证数据库连接字符串的有效性，通过尝试建立连接来确认
- **FR-003**: 系统 MUST 保存数据库连接信息到本地持久化存储，包括连接名称和脱敏后的连接字符串
- **FR-004**: 系统 MUST 支持用户查看所有已添加的数据库连接列表
- **FR-005**: 系统 MUST 支持用户删除已添加的数据库连接
- **FR-006**: 系统 MUST 在数据库连接列表中显示每个数据库的连接状态（已连接/连接失败）
- **FR-007**: 系统 MUST 支持 PostgreSQL 和 MySQL 数据库，暂不支持其他数据库类型

#### 元数据提取与展示

- **FR-008**: 系统 MUST 在用户选择数据库后，自动连接并提取该数据库的元数据
- **FR-009**: 系统 MUST 提取所有表（table）和视图（view）的列表
- **FR-010**: 系统 MUST 提取每个表和视图的结构信息，包括列名、数据类型、是否为主键、是否为外键、是否可空等
- **FR-011**: 系统 MUST 将提取的元数据转换为结构化格式并保存到本地缓存，以便后续快速复用
- **FR-012**: 系统 MUST 在下次访问同一数据库时，优先使用缓存的元数据以提高加载速度
- **FR-013**: 系统 MUST 支持用户手动触发元数据刷新以获取最新的数据库结构
- **FR-014**: 系统 MUST 以清晰的层级结构展示数据库元数据（数据库 > 模式 > 表/视图 > 列）

#### SQL 查询执行

- **FR-015**: 系统 MUST 提供 SQL 编辑器界面，允许用户输入和编辑 SQL 查询语句
- **FR-016**: 系统 MUST 在执行查询前使用 SQL 解析器验证 SQL 语法
- **FR-017**: 系统 MUST 仅允许 SELECT 查询语句执行，拒绝其他类型语句（INSERT、UPDATE、DELETE、DROP 等）
- **FR-018**: 系统 MUST 在检测到非 SELECT 语句时，向用户显示明确的错误提示
- **FR-019**: 系统 MUST 在查询语句不包含 LIMIT 子句时，自动添加 LIMIT 1000
- **FR-020**: 系统 MUST 执行验证通过的 SELECT 查询并获取结果
- **FR-021**: 系统 MUST 将查询结果以结构化格式返回，便于前端展示为表格
- **FR-022**: 系统 MUST 在 SQL 语法错误时，提供具体的错误信息（错误位置和原因）
- **FR-023**: 系统 MUST 支持查询超时机制（60 秒），防止长时间运行的查询阻塞系统

#### 自然语言生成 SQL

- **FR-024**: 系统 MUST 提供自然语言输入界面，允许用户用自然语言描述查询需求
- **FR-025**: 系统 MUST 在生成 SQL 时，将当前数据库的元数据（表和视图的结构信息）作为上下文信息提供给 AI 模型
- **FR-026**: 系统 MUST 使用 AI 智能模型根据自然语言描述和数据库元数据生成 SQL 查询语句
- **FR-027**: 系统 MUST 将生成的 SQL 语句显示在 SQL 编辑器中，允许用户在执行前修改
- **FR-028**: 系统 MUST 在 AI 模型生成的 SQL 语法有误时，向用户说明错误并提供修正建议

#### 查询结果展示与导出

- **FR-029**: 系统 MUST 将查询结果以表格形式展示在界面上
- **FR-030**: 系统 MUST 在结果数据量较大时使用分页展示，每页显示合理数量的行
- **FR-031**: 系统 MUST 支持用户导出查询结果为常用数据格式（如 CSV、电子表格兼容格式）
- **FR-032**: 系统 MUST 支持用户导出查询结果为 CSV 格式，便于在 Excel 等工具中打开
- **FR-033**: 系统 MUST 在查询返回空结果时，显示友好的提示信息

#### 安全与隐私

- **FR-034**: 系统 MUST 在保存数据库连接字符串时，不保存明文密码
- **FR-035**: 系统 MUST 在显示数据库连接信息时，隐藏敏感信息（如密码）
- **FR-036**: 系统 MUST 记录所有查询执行的审计日志，不包括敏感数据
- **FR-037**: 系统 MUST 在用户删除数据库连接时，同时删除相关的元数据缓存

### Key Entities

- **数据库连接 (Database Connection)**: 表示一个数据库连接配置，包含连接名称、数据库类型、脱敏后的连接字符串、连接状态、创建时间等属性。一个用户可以拥有多个数据库连接。

- **数据库元数据 (Database Metadata)**: 表示某个数据库的结构信息，包含数据库列表、模式列表、表和视图列表、每个表/视图的列信息（列名、数据类型、约束等）。元数据与数据库连接关联，并保存提取时间戳用于判断是否需要刷新。

- **查询历史 (Query History)**: 表示用户执行的查询记录，包含查询语句、执行时间、结果行数、所属数据库等信息（不包含实际结果数据）。查询历史与数据库连接关联，用于用户回溯之前的查询。

- **查询结果 (Query Result)**: 表示一次查询执行的结果数据，包含列名（表头）和数据行。查询结果是临时的，不持久化存储，仅在当前会话中展示。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户可以在 1 分钟内完成数据库连接的添加和验证（从输入连接字符串到看到连接成功提示）
- **SC-002**: 系统可以在 5 秒内完成包含 100 个表的数据库元数据提取和展示
- **SC-003**: 使用缓存时，元数据加载时间在 1 秒以内
- **SC-004**: 用户可以在 30 秒内完成从输入自然语言到执行查询的完整流程
- **SC-005**: SQL 语法验证在 500ms 内完成并给出结果
- **SC-006**: 90% 的用户能够在不查看文档的情况下，成功添加数据库连接并执行第一次查询
- **SC-007**: 系统能够准确拦截 100% 的非 SELECT 语句并拒绝执行
- **SC-008**: 自然语言生成的 SQL 查询准确率达到 80% 以上（通过人工评估生成的 SQL 是否符合用户意图）
- **SC-009**: 查询结果在 2 秒内开始展示（即使总数据量很大，也要快速显示第一批数据）
- **SC-010**: 系统支持至少 10 个并发用户同时进行查询操作而不出现性能明显下降

## Assumptions

- 用户具备基本的数据库概念知识（如表、视图、列等）
- 用户提供的数据库连接字符串具有相应数据库的读取权限
- 数据库服务器可以从当前网络环境访问
- AI 智能模型服务可用且在合理的响应时间内（< 10 秒）
- 前端运行在现代浏览器上（Chrome、Firefox、Safari、Edge 的最新版本）
- 单个用户规模在 100 人以内，不需要处理大规模并发
- 查询主要针对读操作，不涉及复杂的写操作管理
- 元数据提取操作不会对生产数据库造成明显的性能影响
- 用户理解并接受查询结果有 LIMIT 1000 的限制，如需更多数据需要手动修改 LIMIT
- 默认支持 PostgreSQL 和 MySQL，暂不支持其他数据库类型，但架构上应预留扩展能力

## Non-Functional Requirements

- **性能**: 元数据提取应在合理时间内完成（100 个表以内 < 10 秒），查询响应应在 2 秒内开始展示结果
- **可用性**: 界面直观清晰，新用户无需培训即可完成基本操作
- **可扩展性**: 系统架构应支持轻松添加新的数据库类型适配器
- **安全性**: 所有数据库连接必须经过验证，敏感信息（密码）不得明文存储或显示
- **可靠性**: 系统应能够优雅地处理网络错误、连接超时、SQL 语法错误等异常情况
- **可维护性**: 代码结构清晰，遵循 SOLID 原则，便于后续维护和功能扩展
